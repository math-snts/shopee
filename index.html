<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Toolbox Shopee ‚Äî Etiquetas ‚Ä¢ Calculadora ‚Ä¢ Dashboard</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    'name': 'Toolbox Shopee',
    'short_name': 'ShopeeTool',
    'description': 'Ferramentas para vendedores Shopee',
    'start_url': '/',
    'display': 'standalone',
    'background_color': '#ff7a18',
    'theme_color': '#ff7a18',
    'icons': [
      {
        'src': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjRkY3QTE4Ii8+CjxwYXRoIGQ9Ik0xMjAgOTZIMzZWMzZIMTIwVjkyNkM5MiAxMjQgNjQgMTUyIDM0LjUgMTUyQzE1LjI1IDE1MiAwIDEzNi42NSAwIDEyMEgxMjBWMzk2SDBWMjYwSDEyMFY5NloiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
        'sizes': '192x192',
        'type': 'image/svg+xml'
      }
    ]
  }">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Bibliotecas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#ff7a18">
  <style>
    /* Enhanced visual polish */
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app-header {
      backdrop-filter: blur(12px);
    }

    /* Smooth transitions with better easing */
    .page {
      display: none;
      animation: fadeIn .25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .page.visible {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Touch targets improved */
    .nav-btn {
      padding: .75rem 1rem;
      border-radius: .75rem;
      transition: all .15s ease;
    }

    .nav-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Loading spinner */
    .spinner {
      border: 2px solid #f3f4f6;
      border-top: 2px solid #f97316;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: .75rem;
      color: white;
      z-index: 50;
      transform: translateX(400px);
      transition: transform .3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background: #10b981;
    }

    .toast.error {
      background: #ef4444;
    }

    /* Improved drop zone */
    .drop-zone {
      transition: all .2s ease;
    }

    .drop-zone.dragover {
      border-color: #f97316;
      background: #fef3c7;
      transform: scale(1.02);
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-orange-50 text-slate-900 min-h-screen">

  <!-- HEADER / NAV -->
  <header class="app-header fixed top-0 left-0 right-0 z-40 bg-white/90 border-b border-slate-200/50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div
          class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-yellow-400 flex items-center justify-center text-white font-bold shadow-lg">
          SH</div>
        <div>
          <div class="text-xl font-bold text-slate-800">Toolbox Shopee</div>
          <div class="text-sm text-slate-500">Etiquetas ‚Ä¢ Calculadora ‚Ä¢ Dashboard Anal√≠tico</div>
        </div>
      </div>

      <nav class="hidden lg:flex items-center gap-3">
        <button
          class="nav-btn text-sm font-semibold text-slate-700 bg-white/80 hover:bg-orange-50 border border-slate-200"
          data-target="home">üè† In√≠cio</button>
        <button
          class="nav-btn text-sm font-semibold text-slate-700 bg-white/80 hover:bg-orange-50 border border-slate-200"
          data-target="etiquetas">üè∑Ô∏è Etiquetas</button>
        <button
          class="nav-btn text-sm font-semibold text-slate-700 bg-white/80 hover:bg-orange-50 border border-slate-200"
          data-target="calculadora">üßÆ Calculadora</button>
        <button
          class="nav-btn text-sm font-semibold text-slate-700 bg-white/80 hover:bg-orange-50 border border-slate-200"
          data-target="dashboard">üìä Dashboard</button>
      </nav>

      <!-- Mobile menu button -->
      <div class="lg:hidden">
        <button id="menuBtn" class="p-2.5 rounded-lg border bg-white shadow-sm hover:shadow-md transition-shadow">
          <svg id="menuIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-600" fill="none"
            viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile dropdown -->
    <div id="mobileMenu" class="lg:hidden hidden border-t bg-white/95 backdrop-blur-sm">
      <div class="px-4 py-4 flex flex-col gap-2">
        <button class="text-left p-3 rounded-lg hover:bg-orange-50 transition-colors" data-target="home">üè†
          In√≠cio</button>
        <button class="text-left p-3 rounded-lg hover:bg-orange-50 transition-colors" data-target="etiquetas">üè∑Ô∏è
          Etiquetas</button>
        <button class="text-left p-3 rounded-lg hover:bg-orange-50 transition-colors" data-target="calculadora">üßÆ
          Calculadora</button>
        <button class="text-left p-3 rounded-lg hover:bg-orange-50 transition-colors" data-target="dashboard">üìä
          Dashboard</button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="pt-20 pb-16">
    <div class="max-w-6xl mx-auto px-4">

      <!-- HOME / DESCRI√á√ÉO -->
      <section id="home" class="page visible bg-white/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl mb-8">
        <div class="lg:flex lg:items-center lg:gap-8">
          <div class="flex-1 mb-6 lg:mb-0">
            <h1 class="text-3xl lg:text-4xl font-extrabold text-slate-800 mb-4">üöÄ Toolbox Shopee ‚Äî Sua Central de
              Expedi√ß√£o & An√°lises</h1>
            <p class="text-lg text-slate-600 mb-6 leading-relaxed">Otimize sua opera√ß√£o com ferramentas integradas: gere
              etiquetas profissionais, calcule margens precisas e analise vendas com insights acion√°veis. PWA completa
              para uso offline e mobile.</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
              <div
                class="p-6 border border-orange-200 rounded-2xl bg-gradient-to-r from-orange-50 to-yellow-50 shadow-md">
                <div class="text-2xl mb-2">üè∑Ô∏è</div>
                <h3 class="font-bold text-slate-800 mb-2">Gerador de Etiquetas</h3>
                <p class="text-sm text-slate-600">ZPL ‚Üí PDF com Labelary. Suporte ZIP/TXT, drag & drop, retry autom√°tico
                  e headers personalizados.</p>
              </div>
              <div
                class="p-6 border border-yellow-200 rounded-2xl bg-gradient-to-r from-yellow-50 to-green-50 shadow-md">
                <div class="text-2xl mb-2">üßÆ</div>
                <h3 class="font-bold text-slate-800 mb-2">Calculadora Avan√ßada</h3>
                <p class="text-sm text-slate-600">Comiss√µes, impostos, afiliados e margens. Salva hist√≥rico local e
                  valida inputs em tempo real.</p>
              </div>
              <div
                class="p-6 border border-purple-200 rounded-2xl bg-gradient-to-r from-purple-50 to-indigo-50 shadow-md">
                <div class="text-2xl mb-2">üìä</div>
                <h3 class="font-bold text-slate-800 mb-2">Dashboard Anal√≠tico</h3>
                <p class="text-sm text-slate-600">KPIs, gr√°ficos de margens, top produtos e recomenda√ß√µes de
                  precifica√ß√£o. Export CSV.</p>
              </div>
            </div>

            <div class="flex flex-wrap gap-4 mb-8">
              <button
                class="bg-orange-500 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all font-semibold"
                data-target="etiquetas">Abrir Etiquetas</button>
              <button
                class="bg-yellow-400 text-black px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all font-semibold"
                data-target="calculadora">Abrir Calculadora</button>
              <button
                class="bg-purple-500 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all font-semibold"
                data-target="dashboard">Abrir Dashboard</button>
            </div>

            <div class="text-sm text-slate-500 bg-slate-50 p-4 rounded-xl">
              <p><strong>‚ú® Novidades:</strong> PWA offline, valida√ß√µes robustas, export de insights e an√°lises
                preditivas para decis√µes r√°pidas.</p>
            </div>
          </div>

          <div class="hidden lg:block w-64">
            <div class="bg-gradient-to-br from-orange-100 to-yellow-100 rounded-2xl p-6 shadow-lg">
              <img
                src="https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=2b4a4e8f4e4e4e4e4e4e4e4e4e4e4e4"
                alt="Dashboard mockup" class="rounded-xl shadow-md w-full" />
            </div>
          </div>
        </div>
      </section>

      <!-- ETIQUETAS / ZPL -> PDF -->
      <section id="etiquetas" class="page mb-8 bg-white/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-slate-800">üè∑Ô∏è Gerador de Etiquetas Profissionais</h2>
          <div class="text-sm text-slate-500 flex items-center gap-2">
            <span>Selecione .txt ou .zip</span>
            <div class="spinner hidden" id="etqSpinner"></div>
          </div>
        </div>

        <div class="grid gap-6">
          <div
            class="flex flex-col md:flex-row gap-4 items-start p-4 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50">
            <input type="file" id="etqFileInput" multiple class="flex-1 p-3 border rounded-xl bg-white shadow-sm"
              accept=".txt,.zip">
            <input type="text" id="etqRedeSocial" placeholder="Rede social (ex: Instagram @loja)"
              class="p-3 border rounded-xl w-full md:w-64 bg-white shadow-sm">
            <div class="flex gap-3">
              <button id="etqProcessBtn"
                class="bg-orange-500 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all font-semibold flex items-center gap-2">
                Gerar PDF
              </button>
              <button id="etqClearBtn"
                class="bg-white border px-6 py-3 rounded-xl shadow-sm hover:shadow-md transition-all">Limpar</button>
            </div>
          </div>

          <div id="etqDropZone"
            class="drop-zone p-8 border-2 border-dashed border-slate-200 rounded-2xl text-center text-slate-500 cursor-pointer hover:border-orange-300 transition-colors">
            <div class="text-4xl mb-2">üìÅ</div>
            <p class="text-lg font-medium mb-1">Arraste arquivos aqui</p>
            <p class="text-sm">Ou clique para selecionar .txt ou .zip</p>
          </div>

          <div class="bg-slate-50 p-4 rounded-xl">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-slate-600">Progresso:</span>
              <span id="etqProgressText" class="text-sm text-slate-500">0/0</span>
            </div>
            <div class="h-3 bg-slate-200 rounded-full overflow-hidden">
              <div id="etqProgress" class="h-full bg-gradient-to-r from-orange-400 to-yellow-400 w-0 transition-all">
              </div>
            </div>
            <div class="mt-2 text-sm text-slate-500 flex justify-between">
              <span id="etqEta">Tempo: --</span>
              <span id="etqSpeed">Velocidade: --/s</span>
            </div>
            <div class="mt-3 text-sm text-slate-600 max-h-32 overflow-auto p-2 bg-white rounded" id="etqStatus"></div>
          </div>
        </div>
      </section>

      <!-- CALCULADORA -->
      <section id="calculadora" class="page mb-8 bg-white/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-slate-800">üßÆ Calculadora de Margens Shopee</h2>
          <div class="text-sm text-slate-500">Valida√ß√µes autom√°ticas e hist√≥rico salvo</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Valor de Venda (R$)</label>
            <input type="number" id="c_valorVenda" min="0" step="0.01" placeholder="Ex: 29.90"
              class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Comiss√£o Shopee (%)</label>
            <input type="number" id="c_taxaComissao" min="0" max="100" step="0.01" placeholder="Ex: 12.00"
              class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Taxa de Servi√ßo (%)</label>
            <input type="number" id="c_taxaServico" min="0" max="100" step="0.01" placeholder="Ex: 2.00"
              class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Taxa por Item (R$)</label>
            <input type="number" id="c_taxaItem" min="0" step="0.01" placeholder="Ex: 0.50"
              class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Al√≠quota Imposto (%)</label>
            <input type="number" id="c_aliquota" min="0" max="100" step="0.01" placeholder="Ex: 12.00"
              class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Afiliado (%)</label>
            <input type="number" id="c_afiliado" min="0" max="100" step="0.01" placeholder="Ex: 5.00"
              class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
          </div>
          <div class="lg:col-span-2">
            <label class="block text-sm font-medium text-slate-700 mb-1">Pre√ßo de Custo (R$)</label>
            <input type="number" id="c_precoCusto" min="0" step="0.01" placeholder="Ex: 15.00"
              class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
          </div>
        </div>

        <div class="flex gap-4 mb-6">
          <button id="c_calcularBtn"
            class="bg-orange-500 text-white px-8 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all font-semibold flex items-center gap-2">
            Calcular Margem
          </button>
          <button id="c_limparBtn"
            class="bg-white border px-8 py-3 rounded-xl shadow-sm hover:shadow-md transition-all">Limpar</button>
          <button id="c_salvarBtn"
            class="bg-green-500 text-white px-8 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all">üíæ
            Salvar</button>
        </div>

        <div id="c_resultado"
          class="hidden bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-2xl border border-green-200">
          <h3 class="text-xl font-bold text-green-800 mb-4">Resultados da An√°lise</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div class="bg-white p-4 rounded-xl shadow-sm">
              <strong class="text-lg text-green-700 block mb-1">Taxa Shopee Total</strong>
              <span class="text-2xl font-bold">R$ <span id="c_taxaShopee">0</span></span>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm">
              <strong class="text-lg text-blue-700 block mb-1">Valor L√≠quido</strong>
              <span class="text-2xl font-bold">R$ <span id="c_valorLiquido">0</span></span>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm">
              <strong class="text-lg text-emerald-700 block mb-1">Lucro L√≠quido</strong>
              <span class="text-2xl font-bold">R$ <span id="c_lucroLiquido">0</span></span>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm">
              <strong class="text-lg text-purple-700 block mb-1">Imposto Estimado</strong>
              <span class="text-2xl font-bold">R$ <span id="c_imposto">0</span></span>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm">
              <strong class="text-lg text-pink-700 block mb-1">Afiliado</strong>
              <span class="text-2xl font-bold">R$ <span id="c_afiliadoValor">0</span></span>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm">
              <strong class="text-lg text-orange-700 block mb-1">Margem Final</strong>
              <span class="text-2xl font-bold text-orange-600"><span id="c_margem">0</span>%</span>
            </div>
          </div>
        </div>

        <!-- Hist√≥rico Salvo -->
        <div id="c_historico" class="hidden mt-6">
          <h4 class="text-lg font-bold mb-3">üìã Hist√≥rico de C√°lculos</h4>
          <div id="c_historicoList" class="space-y-2 max-h-40 overflow-auto bg-slate-50 p-4 rounded-xl"></div>
        </div>
      </section>

      <!-- DASHBOARD ANAL√çTICO SHOPPING -->
      <section id="dashboard" class="page mt-6 bg-white rounded-2xl p-6 shadow-sm">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-xl font-bold">üìà Dashboard Anal√≠tico - Sacolas Personalizadas</h2>
            <p class="text-sm text-slate-500 mt-1">An√°lise de rentabilidade e decis√µes de precifica√ß√£o</p>
          </div>
          <div class="flex gap-2">
            <input type="file" id="dbFileInput" accept=".csv,.xlsx" class="hidden">
            <label for="dbFileInput"
              class="bg-orange-500 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-orange-600">
              üìÅ Upload Relat√≥rio
            </label>
            <button id="dbResetBtn" class="bg-white border px-4 py-2 rounded-lg text-sm">üîÑ Reset</button>
            <button id="dbDebugBtn" class="bg-slate-100 border px-3 py-2 rounded text-xs">üîç Debug</button>
          </div>
        </div>

        <!-- Status Upload -->
        <div id="dbStatus" class="mb-4 p-3 rounded-lg hidden border">
          <div class="flex items-center gap-2 text-sm">
            <div id="dbStatusIcon" class="w-4 h-4 rounded-full"></div>
            <span id="dbStatusText"></span>
          </div>
        </div>

        <!-- KPIs Principais -->
        <div id="dbKpis" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-6 hidden">
          <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl shadow-sm text-center">
            <p class="text-xs text-slate-500 font-medium">Faturamento Bruto</p>
            <p id="dbFaturamento" class="text-lg font-bold text-orange-700">-</p>
          </div>
          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl shadow-sm text-center">
            <p class="text-xs text-slate-500 font-medium">Lucro L√≠quido</p>
            <p id="dbLucro" class="text-lg font-bold text-green-700">-</p>
            <p id="dbMargemGeral" class="text-xs text-slate-400">-</p>
          </div>
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl shadow-sm text-center">
            <p class="text-xs text-slate-500 font-medium">Pedidos √önicos</p>
            <p id="dbPedidos" class="text-lg font-bold text-blue-700">-</p>
          </div>
          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl shadow-sm text-center">
            <p class="text-xs text-slate-500 font-medium">Ticket M√©dio</p>
            <p id="dbTicketMedio" class="text-lg font-bold text-purple-700">-</p>
          </div>
          <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-xl shadow-sm text-center">
            <p class="text-xs text-slate-500 font-medium">Taxas Shopee</p>
            <p id="dbTaxasTotais" class="text-lg font-bold text-yellow-700">-</p>
            <p id="dbTaxasPerc" class="text-xs text-slate-400">-</p>
          </div>
          <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 rounded-xl shadow-sm text-center">
            <p class="text-xs text-slate-500 font-medium">Frete M√©dio</p>
            <p id="dbFreteMedio" class="text-lg font-bold text-indigo-700">-</p>
          </div>
          <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl shadow-sm text-center">
            <p class="text-xs text-slate-500 font-medium">ROI Geral</p>
            <p id="dbRoi" class="text-lg font-bold text-emerald-700">-</p>
          </div>
          <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl shadow-sm text-center">
            <p class="text-xs text-slate-500 font-medium">Devolu√ß√µes</p>
            <p id="dbDevolucoes" class="text-lg font-bold text-red-700">-</p>
            <p id="dbDevolucoesPerc" class="text-xs text-slate-400">-</p>
          </div>
        </div>

        <!-- An√°lises e Insights -->
        <div id="dbAnalises" class="mb-6 hidden">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">üéØ Insights & Recomenda√ß√µes</h3>
            <div class="flex gap-2">
              <button id="dbExportInsights" class="bg-green-500 text-white px-4 py-2 rounded-lg shadow-sm text-sm">üìä
                Export CSV</button>
              <button id="dbToggleAnalise" class="bg-slate-100 px-3 py-2 rounded text-xs">üëÅÔ∏è Ver detalhes</button>
            </div>
          </div>

          <!-- Cards de Insights -->
          <div id="dbRecomendacoes" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
            <!-- Preenchido via JS -->
          </div>
        </div>

        <!-- Gr√°ficos -->
        <div id="dbCharts" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
          <div class="bg-white p-4 rounded-xl shadow-sm lg:col-span-1">
            <h3 class="font-bold mb-3 text-slate-800">üìä Margem por Produto</h3>
            <div class="h-48"><canvas id="dbMargemChart"></canvas></div>
          </div>
          <div class="bg-white p-4 rounded-xl shadow-sm">
            <h3 class="font-bold mb-3 text-slate-800">üí∞ Composi√ß√£o das Taxas</h3>
            <div class="h-48"><canvas id="dbPieChart"></canvas></div>
          </div>
          <div class="bg-white p-4 rounded-xl shadow-sm">
            <h3 class="font-bold mb-3 text-slate-800">üèÜ Top 8 Produtos</h3>
            <div class="h-48 mb-3"><canvas id="dbTopBarChart"></canvas></div>
            <div class="text-xs text-center text-slate-500 mb-2">por Quantidade Vendida</div>
          </div>
        </div>

        <!-- Tabela Detalhada -->
        <div id="dbDetalhes" class="hidden mt-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">üìã An√°lise Detalhada por Produto</h3>
            <button id="dbToggleDetalhes" class="bg-slate-100 px-3 py-2 rounded text-xs">üëÅÔ∏è Ocultar</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left border-collapse bg-white rounded-lg shadow-sm">
              <thead class="bg-slate-100">
                <tr>
                  <th class="p-3 border font-medium">Produto</th>
                  <th class="p-3 border font-medium text-center">Qtd Vendida</th>
                  <th class="p-3 border font-medium text-right">Faturamento</th>
                  <th class="p-3 border font-medium text-right">Margem %</th>
                  <th class="p-3 border font-medium text-center">Taxa Efetiva</th>
                  <th class="p-3 border font-medium text-center">Recomenda√ß√£o</th>
                </tr>
              </thead>
              <tbody id="dbTabelaProdutos"></tbody>
            </table>
          </div>
        </div>

        <!-- Debug Panel -->
        <div id="dbDebug" class="hidden mt-6">
          <div class="flex justify-between items-center mb-2">
            <h4 class="font-semibold text-sm">üîç Debug - Mapeamento de Colunas</h4>
            <button id="dbDebugClose" class="text-slate-400 hover:text-slate-600 text-xs">√ó</button>
          </div>
          <pre id="dbDebugText" class="bg-slate-50 p-3 rounded text-xs max-h-48 overflow-auto font-mono border"></pre>
        </div>
      </section>
  </main>

  <!-- FOOTER -->
  <footer class="fixed bottom-6 left-1/2 -translate-x-1/2 z-30">
    <div
      class="bg-white/95 backdrop-blur-sm px-6 py-3 rounded-full shadow-lg flex items-center gap-3 text-sm text-slate-600">
      <span>‚ú® Feito com ‚ù§Ô∏è para vendedores Shopee | v2.0 by Matheus</span>
    </div>
  </footer>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <!-- SCRIPTS: SPA, PWA, integra√ß√µes -->
  <script>
    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
        const CACHE_NAME = 'toolbox-v2';
        const urlsToCache = ['/', 'https://cdn.tailwindcss.com'];
        
        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME)
              .then(cache => cache.addAll(urlsToCache))
          );
        });
        
        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request)
              .then(response => response || fetch(event.request))
          );
        });
      `)).then(reg => console.log('SW registrado')).catch(err => console.log('SW erro:', err));
      });
    }

    /* ---------- Global Error Handler ---------- */
    window.addEventListener('error', (e) => {
      showToast('Ops! Erro detectado. Verifique o console (F12).', 'error');
      console.error('Erro global:', e.error);
    });

    /* ---------- Toast Notifications ---------- */
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerText = message;
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    /* ---------- SPA Navigation ---------- */
    const pages = document.querySelectorAll('.page');
    function showPage(id) {
      pages.forEach(p => p.classList.remove('visible'));
      const el = document.getElementById(id);
      if (el) el.classList.add('visible');
      // Lazy init
      if (id === 'etiquetas') initEtiquetasUI();
      if (id === 'calculadora') initCalculadoraUI();
      if (id === 'dashboard') initDashboardUI();
      // Close mobile menu
      document.getElementById('mobileMenu').classList.add('hidden');
      // Update URL for PWA
      history.pushState({ page: id }, '', `#${id}`);
    }
    document.querySelectorAll('[data-target]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const t = e.currentTarget.dataset.target;
        showPage(t);
      });
    });
    // Mobile menu
    document.getElementById('menuBtn').addEventListener('click', () => {
      document.getElementById('mobileMenu').classList.toggle('hidden');
    });
    // Popstate for back button
    window.addEventListener('popstate', (e) => {
      if (e.state && e.state.page) showPage(e.state.page);
    });

    /* ---------- UTIL ---------- */
    function fmtBR(value) {
      try {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
      } catch (e) {
        return 'R$ ' + Number(value).toFixed(2).replace('.', ',');
      }
    }

    /* ============================
       ETIQUETAS (ZPL -> PDF) - MELHORADO
       ============================ */
    let etqFileList = [];
    function initEtiquetasUI() {
      if (initEtiquetasUI.inited) return; initEtiquetasUI.inited = true;

      const input = document.getElementById('etqFileInput');
      const drop = document.getElementById('etqDropZone');
      const processBtn = document.getElementById('etqProcessBtn');
      const clearBtn = document.getElementById('etqClearBtn');
      const status = document.getElementById('etqStatus');
      const progressBar = document.getElementById('etqProgress');
      const progressText = document.getElementById('etqProgressText');
      const etaEl = document.getElementById('etqEta');
      const spinner = document.getElementById('etqSpinner');

      // Valida√ß√£o de arquivo
      input.addEventListener('change', (e) => {
        const files = Array.from(e.target.files || []);
        const validFiles = files.filter(f => f.name.toLowerCase().match(/\.(txt|zip)$/));
        if (validFiles.length !== files.length) {
          showToast('Apenas .txt e .zip s√£o aceitos!', 'error');
          e.target.value = '';
          return;
        }
        etqFileList = validFiles;
        progressText.textContent = `${etqFileList.length} arquivo(s) pronto(s)`;
      });

      // Drag & Drop melhorado
      drop.addEventListener('click', () => input.click());
      drop.addEventListener('dragover', (e) => {
        e.preventDefault();
        drop.classList.add('dragover');
      });
      drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
      drop.addEventListener('drop', (e) => {
        e.preventDefault();
        drop.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files || []);
        const validFiles = files.filter(f => f.name.toLowerCase().match(/\.(txt|zip)$/));
        if (validFiles.length !== files.length) {
          showToast('Apenas .txt e .zip s√£o aceitos!', 'error');
          return;
        }
        etqFileList = validFiles;
        input.files = validFiles;
        progressText.textContent = `${etqFileList.length} arquivo(s) carregado(s)`;
      });

      processBtn.addEventListener('click', async () => {
        if (!etqFileList.length) return showToast('Selecione arquivos primeiro!', 'error');
        spinner.classList.remove('hidden');
        processBtn.disabled = true;
        progressBar.style.width = '0%';
        status.innerHTML = '';
        etaEl.textContent = 'Processando...';

        try {
          const hoje = new Date();
          const dataStr = hoje.toISOString().split('T')[0].replace(/-/g, '');
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({ unit: 'mm', format: [100, 150] });
          const totalStart = Date.now();
          let etiquetas = [];
          let processed = 0;

          // Extrair ZPL com rate limiting
          for (const f of etqFileList) {
            try {
              if (f.name.toLowerCase().endsWith('.zip')) {
                const data = await f.arrayBuffer();
                const zip = await JSZip.loadAsync(data);
                for (const name of Object.keys(zip.files)) {
                  if (name.toLowerCase().endsWith('.txt')) {
                    const txt = await zip.files[name].async('string');
                    etiquetas.push(...await extractZplBlocks(txt));
                  }
                }
              } else if (f.name.toLowerCase().endsWith('.txt')) {
                const txt = await f.text();
                etiquetas.push(...await extractZplBlocks(txt));
              }
              log(`‚úÖ ${f.name} processado`);
            } catch (e) {
              log(`‚ùå Erro em ${f.name}: ${e.message}`);
            }
          }

          if (!etiquetas.length) throw new Error('Nenhuma etiqueta ZPL encontrada!');

          progressText.textContent = `0/${etiquetas.length}`;
          let successCount = 0;

          for (let i = 0; i < etiquetas.length; i++) {
            const zpl = etiquetas[i];
            try {
              // Rate limiting: 200ms delay
              await new Promise(r => setTimeout(r, 200));

              const res = await fetch("https://api.labelary.com/v1/printers/8dpmm/labels/4x6/0/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded", "Accept": "image/png" },
                body: zpl
              });
              if (!res.ok) throw new Error(`Labelary: ${res.status}`);
              const blob = await res.blob();
              const imgData = await blobToDataURL(blob);

              if (i > 0) pdf.addPage();
              pdf.addImage(imgData, "PNG", 0, 0, 100, 150);

              // Header personalizado
              const rede = document.getElementById('etqRedeSocial').value || '';
              pdf.setFontSize(10);
              pdf.text(rede, 5, 5);
              pdf.text(`${i + 1}/${etiquetas.length}`, 95, 5, { align: 'right' });

              successCount++;
              log(`‚úÖ Etiqueta ${i + 1}/${etiquetas.length} gerada`);
            } catch (e) {
              log(`‚ùå Erro na etiqueta ${i + 1}: ${e.message} - Retry...`);
              i--; // Retry
              await new Promise(r => setTimeout(r, 500));
              continue;
            }

            processed++;
            const percent = Math.round((processed / etiquetas.length) * 100);
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${processed}/${etiquetas.length}`;

            const elapsed = (Date.now() - totalStart) / processed;
            const remaining = ((etiquetas.length - processed) * elapsed / 1000).toFixed(1);
            etaEl.textContent = `${remaining}s restantes`;
          }

          const fileName = `etiquetas-shopee-${dataStr}-${successCount}.pdf`;
          pdf.save(fileName);
          showToast(`‚úÖ PDF gerado: ${successCount} etiquetas!`, 'success');
          log(`üéâ PDF salvo: ${fileName}`);

        } catch (e) {
          showToast(`‚ùå Erro geral: ${e.message}`, 'error');
          log(`‚ùå Erro: ${e.message}`);
        } finally {
          spinner.classList.add('hidden');
          processBtn.disabled = false;
          etqFileList = [];
          input.value = '';
        }
      });

      clearBtn.addEventListener('click', () => {
        etqFileList = [];
        input.value = '';
        progressBar.style.width = '0%';
        progressText.textContent = '0/0';
        status.innerHTML = '';
        etaEl.textContent = '--';
        showToast('Limpo!', 'success');
      });

      function log(msg) {
        const line = document.createElement('div');
        line.className = 'text-sm py-1';
        line.innerHTML = `<span class="text-slate-600">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
        status.appendChild(line);
        status.scrollTop = status.scrollHeight;
      }

      async function blobToDataURL(blob) {
        return new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onloadend = () => res(reader.result);
          reader.onerror = rej;
          reader.readAsDataURL(blob);
        });
      }

      async function extractZplBlocks(text) {
        const out = [];
        if (!text) return out;
        if (text.includes("~DGR:DEMO.GRF")) {
          const regex = /~DGR:DEMO\.GRF[\s\S]*?:DEMO\.GRF\^FS\^XZ/gm;
          let m;
          while ((m = regex.exec(text)) !== null) {
            let b = m[0].trim().replace(/[^\x09\x0A\x0D\x20-\x7E]/g, '');
            out.push(b);
          }
        } else {
          const regex = /\^XA[\s\S]*?\^XZ/gm;
          let m;
          while ((m = regex.exec(text)) !== null) {
            let b = m[0].trim().replace(/[^\x09\x0A\x0D\x20-\x7E]/g, '');
            out.push(b);
          }
        }
        return out;
      }
    }

    /* ============================
       CALCULADORA - MELHORADA COM LOCALSTORAGE
       ============================ */
    let calcHistorico = JSON.parse(localStorage.getItem('shopee-calc-hist') || '[]');
    function initCalculadoraUI() {
      if (initCalculadoraUI.inited) return; initCalculadoraUI.inited = true;

      const inputs = {
        valorVenda: document.getElementById('c_valorVenda'),
        taxaComissao: document.getElementById('c_taxaComissao'),
        taxaServico: document.getElementById('c_taxaServico'),
        taxaItem: document.getElementById('c_taxaItem'),
        aliquota: document.getElementById('c_aliquota'),
        afiliado: document.getElementById('c_afiliado'),
        precoCusto: document.getElementById('c_precoCusto')
      };
      const calcularBtn = document.getElementById('c_calcularBtn');
      const limparBtn = document.getElementById('c_limparBtn');
      const salvarBtn = document.getElementById('c_salvarBtn');
      const resultado = document.getElementById('c_resultado');
      const historicoDiv = document.getElementById('c_historico');
      const historicoList = document.getElementById('c_historicoList');

      // Carregar √∫ltimo c√°lculo salvo
      if (localStorage.getItem('shopee-calc-last')) {
        const last = JSON.parse(localStorage.getItem('shopee-calc-last'));
        Object.keys(inputs).forEach(key => inputs[key].value = last[key] || '');
        calcularVenda(); // Auto-calcular
      }

      // Valida√ß√£o em tempo real
      Object.values(inputs).forEach(input => {
        input.addEventListener('input', () => {
          if (input.value && (isNaN(input.value) || parseFloat(input.value) < 0)) {
            input.style.borderColor = '#ef4444';
          } else {
            input.style.borderColor = '';
          }
        });
      });

      calcularBtn.addEventListener('click', () => {
        if (validateInputs(inputs)) {
          calcularVenda();
          salvarEstadoAtual(); // Salva estado atual
        } else {
          showToast('Verifique os valores num√©ricos!', 'error');
        }
      });

      limparBtn.addEventListener('click', () => {
        Object.values(inputs).forEach(input => input.value = '');
        resultado.classList.add('hidden');
        historicoDiv.classList.add('hidden');
        localStorage.removeItem('shopee-calc-last');
        showToast('Limpo!', 'success');
      });

      salvarBtn.addEventListener('click', () => {
        const state = getEstadoAtual();
        calcHistorico.unshift(state);
        calcHistorico = calcHistorico.slice(0, 10); // Limita a 10
        localStorage.setItem('shopee-calc-hist', JSON.stringify(calcHistorico));
        renderHistorico();
        showToast('Salvo no hist√≥rico!', 'success');
      });

      // Render hist√≥rico
      if (calcHistorico.length) {
        historicoDiv.classList.remove('hidden');
        renderHistorico();
      }

      function validateInputs(inputs) {
        return Object.values(inputs).every(input => !input.value || (!isNaN(input.value) && parseFloat(input.value) >= 0));
      }

      function getEstadoAtual() {
        return {
          valorVenda: inputs.valorVenda.value,
          taxaComissao: inputs.taxaComissao.value,
          taxaServico: inputs.taxaServico.value,
          taxaItem: inputs.taxaItem.value,
          aliquota: inputs.aliquota.value,
          afiliado: inputs.afiliado.value,
          precoCusto: inputs.precoCusto.value,
          data: new Date().toLocaleString('pt-BR')
        };
      }

      function salvarEstadoAtual() {
        localStorage.setItem('shopee-calc-last', JSON.stringify(getEstadoAtual()));
      }

      function renderHistorico() {
        historicoList.innerHTML = '';
        calcHistorico.forEach((item, idx) => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer';
          div.innerHTML = `
          <div class="text-sm">
            <div class="font-medium">${fmtBR(item.valorVenda)} - Margem: ${calcularMargem(item).toFixed(1)}%</div>
            <div class="text-xs text-slate-500">${item.data}</div>
          </div>
          <button onclick="carregarHistorico(${idx})" class="text-xs text-blue-500 hover:text-blue-700">Carregar</button>
        `;
          historicoList.appendChild(div);
        });
      }

      window.carregarHistorico = (idx) => {
        const item = calcHistorico[idx];
        Object.keys(inputs).forEach(key => inputs[key].value = item[key] || '');
        calcularVenda();
        showToast('Carregado do hist√≥rico!', 'success');
      };

      function calcularMargem(item) {
        const venda = parseFloat(item.valorVenda) || 0;
        const custo = parseFloat(item.precoCusto) || 0;
        if (!venda) return 0;
        const taxaCom = (parseFloat(item.taxaComissao) || 0) / 100 * venda;
        const taxaServ = (parseFloat(item.taxaServico) || 0) / 100 * venda;
        const taxaItem = parseFloat(item.taxaItem) || 0;
        const aliquota = (parseFloat(item.aliquota) || 0) / 100 * venda;
        const afiliado = (parseFloat(item.afiliado) || 0) / 100 * venda;
        const taxas = taxaCom + taxaServ + taxaItem + aliquota + afiliado;
        const liquido = venda - taxas - custo;
        return venda ? (liquido / venda * 100) : 0;
      }

      function calcularVenda() {
        const valorVenda = parseFloat(inputs.valorVenda.value) || 0;
        const taxaComissao = (parseFloat(inputs.taxaComissao.value) || 0) / 100;
        const taxaServico = (parseFloat(inputs.taxaServico.value) || 0) / 100;
        const taxaItem = parseFloat(inputs.taxaItem.value) || 0;
        const aliquota = (parseFloat(inputs.aliquota.value) || 0) / 100;
        const afiliado = (parseFloat(inputs.afiliado.value) || 0) / 100;
        const precoCusto = parseFloat(inputs.precoCusto.value) || 0;

        if (valorVenda <= 0) return showToast('Insira um valor de venda v√°lido!', 'error');

        const comissao = valorVenda * taxaComissao;
        const servico = valorVenda * taxaServico;
        const imposto = valorVenda * aliquota;
        const afiliadoValor = valorVenda * afiliado;
        const taxaShopee = comissao + servico + taxaItem;
        const valorLiquido = valorVenda - taxaShopee - imposto - afiliadoValor;
        const lucroLiquido = valorLiquido - precoCusto;
        const margem = valorVenda ? (lucroLiquido / valorVenda * 100).toFixed(2) : 0;

        document.getElementById("c_taxaShopee").innerText = taxaShopee.toFixed(2);
        document.getElementById("c_imposto").innerText = imposto.toFixed(2);
        document.getElementById("c_afiliadoValor").innerText = afiliadoValor.toFixed(2);
        document.getElementById("c_valorLiquido").innerText = valorLiquido.toFixed(2);
        document.getElementById("c_lucroLiquido").innerText = lucroLiquido.toFixed(2);
        document.getElementById("c_margem").innerText = margem;

        resultado.classList.remove('hidden');
        historicoDiv.classList.remove('hidden');
      }
    }

    /* ============================
       DASHBOARD ANAL√çTICO - VERS√ÉO 2.0
       ============================ */
    let dbPieChart = null, dbTopBarChart = null, dbMargemChart = null;
    let dashboardData = null; // Cache global dos dados processados

    function initDashboardUI() {
      if (initDashboardUI.inited) return; initDashboardUI.inited = true;

      // Elements
      const fileInput = document.getElementById('dbFileInput');
      const resetBtn = document.getElementById('dbResetBtn');
      const debugBtn = document.getElementById('dbDebugBtn');
      const debugPanel = document.getElementById('dbDebug');
      const debugText = document.getElementById('dbDebugText');
      const debugClose = document.getElementById('dbDebugClose');
      const statusDiv = document.getElementById('dbStatus');
      const statusIcon = document.getElementById('dbStatusIcon');
      const statusText = document.getElementById('dbStatusText');
      const analisesDiv = document.getElementById('dbAnalises');
      const detalhesDiv = document.getElementById('dbDetalhes');
      const toggleAnalise = document.getElementById('dbToggleAnalise');
      const toggleDetalhes = document.getElementById('dbToggleDetalhes');
      const exportInsights = document.getElementById('dbExportInsights');

      // Drag & Drop
      const dropZone = fileInput.parentElement.parentElement;
      dropZone.addEventListener('dragover', handleDragOver);
      dropZone.addEventListener('dragleave', handleDragLeave);
      dropZone.addEventListener('drop', handleDrop);

      function handleDragOver(e) {
        e.preventDefault();
        dropZone.classList.add('border-orange-300', 'bg-orange-50');
      }

      function handleDragLeave(e) {
        dropZone.classList.remove('border-orange-300', 'bg-orange-50');
      }

      function handleDrop(e) {
        e.preventDefault();
        dropZone.classList.remove('border-orange-300', 'bg-orange-50');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          handleFileUpload(files[0]);
        }
      }

      // File upload handler
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileUpload(e.target.files[0]);
        }
      });

      async function handleFileUpload(file) {
        if (!file) return;

        // Valida√ß√£o
        const validTypes = ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
        if (!validTypes.includes(file.type)) {
          showStatus('‚ùå Formato n√£o suportado. Use CSV ou XLSX da Shopee.', 'error');
          return;
        }

        showStatus('‚è≥ Processando relat√≥rio Shopee...', 'loading');

        try {
          const data = await file.arrayBuffer();
          const wb = XLSX.read(data, { type: 'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { defval: null, raw: false });

          if (!json || json.length < 2) {
            throw new Error('Arquivo sem dados v√°lidos');
          }

          console.log('‚úÖ Dados carregados:', json.length - 1, 'itens processados');
          dashboardData = await processShopeeData(json);
          renderDashboard();
          showStatus(`‚úÖ ${dashboardData.itens} itens processados | ${dashboardData.pedidos} pedidos √∫nicos`, 'success');

        } catch (error) {
          console.error('‚ùå Erro:', error);
          showStatus(`‚ùå Erro: ${error.message}`, 'error');
          debugText.textContent += `\n\n--- ERRO ---\n${error.stack}`;
        }
      }

      // Status helper
      function showStatus(message, type) {
        statusDiv.classList.remove('hidden');
        statusText.textContent = message;

        statusIcon.className = 'w-4 h-4 rounded-full';
        statusDiv.className = 'mb-4 p-3 rounded-lg border';

        switch (type) {
          case 'loading':
            statusIcon.className += ' bg-blue-400 animate-pulse';
            statusDiv.className += ' bg-blue-50 border-blue-200';
            break;
          case 'success':
            statusIcon.className += ' bg-green-400';
            statusDiv.className += ' bg-green-50 border-green-200';
            break;
          case 'error':
            statusIcon.className += ' bg-red-400';
            statusDiv.className += ' bg-red-50 border-red-200';
            break;
        }
      }

      // Processamento espec√≠fico para relat√≥rio Shopee
      async function processShopeeData(rows) {
        console.log('üîç Processando relat√≥rio Shopee...');

        // Mapeamento otimizado para colunas do seu relat√≥rio
        const headerMap = buildHeaderMap(rows[0]);
        const colunas = {
          idPedido: findHeader(headerMap, ['id do pedido', 'order id', 'numero do pedido']),
          statusPedido: findHeader(headerMap, ['status do pedido', 'order status']),
          nomeProduto: findHeader(headerMap, ['nome do produto', 'product name', 'nome do item']),
          precoAcordado: findHeader(headerMap, ['pre√ßo acordado', 'preco acordado', 'valor do produto']),
          quantidade: findHeader(headerMap, ['quantidade', 'quantity', 'qty']),
          subtotalProduto: findHeader(headerMap, ['subtotal do produto', 'valor total', 'total amount']),
          taxaTransacao: findHeader(headerMap, ['taxa de transa√ß√£o', 'transaction fee']),
          taxaComissao: findHeader(headerMap, ['taxa de comiss√£o', 'commission fee']),
          taxaServico: findHeader(headerMap, ['taxa de servi√ßo', 'service fee']),
          freteEstimado: findHeader(headerMap, ['valor estimado do frete', 'shipping fee']),
          totalGlobal: findHeader(headerMap, ['total global', 'valor total', 'amount received']),
          statusDevolucao: findHeader(headerMap, ['status da devolu√ß√£o / reembolso', 'refund status'])
        };

        console.log('üéØ Colunas mapeadas:', colunas);
        debugText.textContent = `üìã Colunas encontradas:\n${JSON.stringify(colunas, null, 2)}`;

        // Processar dados
        let faturamentoBruto = 0, totalTaxas = 0, totalFrete = 0, totalComissao = 0;
        let totalServico = 0, totalTransacao = 0, itensProcessados = 0;
        let pedidosUnicos = new Set(), produtos = {}, devolucoes = 0;
        let valoresValidos = 0;

        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          const idPedido = row[colunas.idPedido] ? String(row[colunas.idPedido]).trim() : null;
          const status = row[colunas.statusPedido] ? String(row[colunas.statusPedido]).trim() : '';
          const nomeProduto = row[colunas.nomeProduto] ? String(row[colunas.nomeProduto]).trim() : 'Produto n√£o identificado';
          const preco = parseNumberRaw(row[colunas.precoAcordado]);
          const qtd = parseInt(row[colunas.quantidade] || 1) || 1;
          const subtotal = parseNumberRaw(row[colunas.subtotalProduto]) || (preco * qtd);
          const transacao = parseNumberRaw(row[colunas.taxaTransacao]) || 0;
          const comissao = parseNumberRaw(row[colunas.taxaComissao]) || 0;
          const servico = parseNumberRaw(row[colunas.taxaServico]) || 0;
          const frete = parseNumberRaw(row[colunas.freteEstimado]) || 0;
          const totalGlobal = parseNumberRaw(row[colunas.totalGlobal]) || 0;
          const temDevolucao = row[colunas.statusDevolucao] && String(row[colunas.statusDevolucao]).toLowerCase().includes('aprovada');

          // S√≥ processa pedidos "Conclu√≠do" sem devolu√ß√£o
          if (status.toLowerCase() !== 'conclu√≠do' || temDevolucao || !idPedido || preco <= 0) {
            if (temDevolucao) devolucoes++;
            continue;
          }

          // Agrupar por produto (nome simplificado)
          const produtoKey = nomeProduto.split(' - ')[0].trim(); // "100 Sacolas Boca de Palha√ßo"
          if (!produtos[produtoKey]) {
            produtos[produtoKey] = { qtd: 0, faturamento: 0, comissao: 0, servico: 0, transacao: 0, frete: 0, totalGlobal: 0 };
          }

          produtos[produtoKey].qtd += qtd;
          produtos[produtoKey].faturamento += subtotal;
          produtos[produtoKey].comissao += comissao;
          produtos[produtoKey].servico += servico;
          produtos[produtoKey].transacao += transacao;
          produtos[produtoKey].frete += frete;
          produtos[produtoKey].totalGlobal += totalGlobal;

          // Totais gerais
          faturamentoBruto += subtotal;
          totalComissao += comissao;
          totalServico += servico;
          totalTransacao += transacao;
          totalTaxas += (comissao + servico + transacao);
          totalFrete += frete;
          pedidosUnicos.add(idPedido);
          itensProcessados++;
          valoresValidos++;
        }

        const pedidos = pedidosUnicos.size;
        const ticketMedio = pedidos > 0 ? faturamentoBruto / pedidos : 0;
        const freteMedio = valoresValidos > 0 ? totalFrete / valoresValidos : 0;
        const receitaLiquida = faturamentoBruto - totalTaxas;
        const roiGeral = faturamentoBruto > 0 ? ((receitaLiquida / totalTaxas) * 100).toFixed(1) : 0;
        const devolucoesPerc = valoresValidos > 0 ? ((devolucoes / valoresValidos) * 100).toFixed(1) : 0;

        // Calcular margens por produto
        Object.keys(produtos).forEach(produto => {
          const p = produtos[produto];
          const taxasTotais = p.comissao + p.servico + p.transacao;
          const margem = p.faturamento > 0 ? ((p.totalGlobal - taxasTotais) / p.faturamento * 100) : 0;
          p.margem = margem.toFixed(1);
          p.taxaEfetiva = p.faturamento > 0 ? (taxasTotais / p.faturamento * 100) : 0;
          p.recomendacao = getRecomendacao(p.margem, p.taxaEfetiva);
        });

        return {
          itens: itensProcessados,
          pedidos,
          faturamentoBruto,
          receitaLiquida,
          totalTaxas,
          totalFrete,
          totalComissao,
          totalServico,
          totalTransacao,
          ticketMedio,
          freteMedio,
          roiGeral,
          devolucoes,
          devolucoesPerc,
          produtos: Object.entries(produtos)
            .map(([nome, dados]) => ({ nome, ...dados }))
            .sort((a, b) => b.qtd - a.qtd)
        };
      }

      function getRecomendacao(margem, taxaEfetiva) {
        if (margem >= 25) return { texto: '‚úÖ Excelente', cor: 'text-green-600' };
        if (margem >= 15) return { texto: 'üëç Boa', cor: 'text-blue-600' };
        if (margem >= 8) return {
          texto: `‚ö†Ô∏è Regular - Aumente ${((15 - margem) * 1.2).toFixed(1)}% no pre√ßo`,
          cor: 'text-yellow-600'
        };
        return {
          texto: `üö® Baixa - Aumente ${(20 - margem) * 1.5.toFixed(1)}% no pre√ßo ou otimize custos`,
          cor: 'text-red-600'
        };
      }

      function renderDashboard() {
        const data = dashboardData;

        // KPIs
        document.getElementById('dbFaturamento').innerText = fmtBR(data.faturamentoBruto);
        document.getElementById('dbLucro').innerText = fmtBR(data.receitaLiquida);
        document.getElementById('dbMargemGeral').innerText = `${((data.receitaLiquida / data.faturamentoBruto) * 100).toFixed(1)}%`;
        document.getElementById('dbPedidos').innerText = data.pedidos.toLocaleString();
        document.getElementById('dbTicketMedio').innerText = fmtBR(data.ticketMedio);
        document.getElementById('dbTaxasTotais').innerText = fmtBR(data.totalTaxas);
        document.getElementById('dbTaxasPerc').innerText = `${((data.totalTaxas / data.faturamentoBruto) * 100).toFixed(1)}%`;
        document.getElementById('dbFreteMedio').innerText = fmtBR(data.freteMedio);
        document.getElementById('dbRoi').innerText = `${data.roiGeral}%`;
        document.getElementById('dbDevolucoes').innerText = data.devolucoes;
        document.getElementById('dbDevolucoesPerc').innerText = `${data.devolucoesPerc}%`;

        // Mostrar se√ß√µes
        document.getElementById('dbKpis').classList.remove('hidden');
        document.getElementById('dbCharts').classList.remove('hidden');
        analisesDiv.classList.remove('hidden');

        // Insights
        renderInsights();

        // Gr√°ficos
        renderCharts();

        // Tabela
        renderTabelaProdutos();
      }

      function renderInsights() {
        const data = dashboardData;
        const container = document.getElementById('dbRecomendacoes');
        container.innerHTML = '';

        const insights = [
          {
            titulo: 'Margem M√©dia',
            valor: `${((data.receitaLiquida / data.faturamentoBruto) * 100).toFixed(1)}%`,
            cor: data.receitaLiquida / data.faturamentoBruto >= 0.15 ? 'bg-green-100 text-green-800' :
              data.receitaLiquida / data.faturamentoBruto >= 0.08 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800',
            texto: data.receitaLiquida / data.faturamentoBruto >= 0.15 ?
              '‚úÖ Sua margem est√° excelente! Continue assim.' :
              data.receitaLiquida / data.faturamentoBruto >= 0.08 ?
                '‚ö†Ô∏è Margem regular. Considere ajustar pre√ßos.' : 'üö® Margem baixa. A√ß√£o urgente necess√°ria.'
          },
          {
            titulo: 'Taxa Efetiva Shopee',
            valor: `${((data.totalTaxas / data.faturamentoBruto) * 100).toFixed(1)}%`,
            cor: (data.totalTaxas / data.faturamentoBruto) <= 0.12 ? 'bg-green-100 text-green-800' :
              (data.totalTaxas / data.faturamentoBruto) <= 0.18 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800',
            texto: (data.totalTaxas / data.faturamentoBruto) <= 0.12 ?
              '‚úÖ Taxas controladas. Bom gerenciamento.' :
              (data.totalTaxas / data.faturamentoBruto) <= 0.18 ?
                '‚ö†Ô∏è Taxas elevadas. Avalie precifica√ß√£o.' : 'üö® Taxas muito altas. Revise estrat√©gia.'
          },
          {
            titulo: 'ROI sobre Taxas',
            valor: `${data.roiGeral}%`,
            cor: data.roiGeral >= 200 ? 'bg-green-100 text-green-800' :
              data.roiGeral >= 100 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800',
            texto: data.roiGeral >= 200 ?
              '‚úÖ Excelente retorno sobre taxas!' :
              data.roiGeral >= 100 ?
                '‚ö†Ô∏è ROI aceit√°vel. H√° espa√ßo para melhorar.' : 'üö® ROI baixo. Otimize custos.'
          },
          {
            titulo: 'Frete M√©dio',
            valor: fmtBR(data.freteMedio),
            cor: data.freteMedio <= 12 ? 'bg-green-100 text-green-800' :
              data.freteMedio <= 18 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800',
            texto: data.freteMedio <= 12 ?
              '‚úÖ Frete competitivo.' :
              data.freteMedio <= 18 ?
                '‚ö†Ô∏è Frete um pouco alto. Considere op√ß√µes.' : 'üö® Frete muito caro. Impacta competitividade.'
          }
        ];

        insights.forEach(insight => {
          const card = document.createElement('div');
          card.className = `p-4 rounded-xl border shadow-sm ${insight.cor}`;
          card.innerHTML = `
        <div class="font-semibold text-sm mb-1">${insight.titulo}</div>
        <div class="text-lg font-bold mb-2">${insight.valor}</div>
        <div class="text-xs">${insight.texto}</div>
      `;
          container.appendChild(card);
        });
      }

      function renderCharts() {
        const data = dashboardData;

        // Destruir gr√°ficos antigos
        if (dbPieChart) dbPieChart.destroy();
        if (dbTopBarChart) dbTopBarChart.destroy();
        if (dbMargemChart) dbMargemChart.destroy();

        // Gr√°fico de Margens
        const ctxMargem = document.getElementById('dbMargemChart').getContext('2d');
        const topMargens = data.produtos.slice(0, 8);
        dbMargemChart = new Chart(ctxMargem, {
          type: 'bar',
          data: {
            labels: topMargens.map(p => p.nome.substring(0, 25) + '...'),
            datasets: [{
              label: 'Margem %',
              data: topMargens.map(p => parseFloat(p.margem)),
              backgroundColor: topMargens.map(p =>
                parseFloat(p.margem) >= 15 ? '#10B981' :
                  parseFloat(p.margem) >= 8 ? '#F59E0B' : '#EF4444'
              )
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, max: 40 }
            }
          }
        });

        // Gr√°fico de Taxas (Pie)
        const ctxPie = document.getElementById('dbPieChart').getContext('2d');
        dbPieChart = new Chart(ctxPie, {
          type: 'doughnut',
          data: {
            labels: ['Comiss√£o', 'Servi√ßo', 'Transa√ß√£o'],
            datasets: [{
              data: [data.totalComissao, data.totalServico, data.totalTransacao],
              backgroundColor: ['#F59E0B', '#3B82F6', '#EF4444']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const perc = ((context.parsed / total) * 100).toFixed(1);
                    return `${context.label}: R$ ${fmtBR(context.parsed)} (${perc}%)`;
                  }
                }
              }
            }
          }
        });

        // Top Produtos (Bar horizontal)
        const ctxBar = document.getElementById('dbTopBarChart').getContext('2d');
        const top8 = data.produtos.slice(0, 8);
        dbTopBarChart = new Chart(ctxBar, {
          type: 'bar',
          data: {
            labels: top8.map(p => p.nome.substring(0, 20)),
            datasets: [{
              label: 'Quantidade Vendida',
              data: top8.map(p => p.qtd),
              backgroundColor: '#F97316'
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { beginAtZero: true }
            }
          }
        });
      }

      function renderTabelaProdutos() {
        const data = dashboardData;
        const tbody = document.getElementById('dbTabelaProdutos');
        tbody.innerHTML = '';

        data.produtos.slice(0, 20).forEach(produto => {
          const tr = document.createElement('tr');
          const corMargem = produto.margem >= 15 ? 'text-green-600' :
            produto.margem >= 8 ? 'text-yellow-600' : 'text-red-600';
          const corRecomendacao = produto.recomendacao.cor;

          tr.className = 'hover:bg-slate-50';
          tr.innerHTML = `
        <td class="p-3 border font-medium">${produto.nome}</td>
        <td class="p-3 border text-center">${produto.qtd.toLocaleString()}</td>
        <td class="p-3 border text-right">${fmtBR(produto.faturamento)}</td>
        <td class="p-3 border text-right ${corMargem} font-semibold">${produto.margem}%</td>
        <td class="p-3 border text-center">${produto.taxaEfetiva.toFixed(1)}%</td>
        <td class="p-3 border text-center"><span class="${corRecomendacao} text-xs font-medium">${produto.recomendacao.texto}</span></td>
      `;
          tbody.appendChild(tr);
        });
      }

      // Event listeners
      resetBtn.addEventListener('click', resetDashboard);
      debugBtn.addEventListener('click', () => debugPanel.classList.toggle('hidden'));
      debugClose.addEventListener('click', () => debugPanel.classList.add('hidden'));
      toggleAnalise.addEventListener('click', () => analisesDiv.classList.toggle('hidden'));
      toggleDetalhes.addEventListener('click', () => {
        detalhesDiv.classList.toggle('hidden');
        toggleDetalhes.innerText = detalhesDiv.classList.contains('hidden') ? 'üëÅÔ∏è Ver detalhes' : 'üôà Ocultar';
      });

      exportInsights.addEventListener('click', exportarInsights);

      function exportarInsights() {
        const data = dashboardData;
        const csv = [
          ['Dashboard Anal√≠tico - Sacolas Personalizadas'],
          ['Per√≠odo', '01/08/2025 - 31/08/2025'],
          ['', ''],
          ['M√©tricas Gerais', 'Valor', 'Observa√ß√£o'],
          ['Faturamento Bruto', fmtBR(data.faturamentoBruto), 'Total vendido'],
          ['Lucro L√≠quido', fmtBR(data.receitaLiquida), 'Ap√≥s taxas Shopee'],
          ['Margem Geral', `${((data.receitaLiquida / data.faturamentoBruto) * 100).toFixed(1)}%`, 'Rentabilidade m√©dia'],
          ['Pedidos √önicos', data.pedidos, 'N√∫mero de transa√ß√µes'],
          ['Ticket M√©dio', fmtBR(data.ticketMedio), 'Valor m√©dio por pedido'],
          ['Taxas Totais', fmtBR(data.totalTaxas), 'Comiss√£o + Servi√ßo + Transa√ß√£o'],
          ['ROI sobre Taxas', `${data.roiGeral}%`, 'Retorno sobre custos Shopee'],
          ['', ''],
          ['An√°lise por Produto', 'Qtd', 'Faturamento', 'Margem %', 'Taxa Efetiva %', 'Recomenda√ß√£o']
        ];

        data.produtos.slice(0, 15).forEach(p => {
          csv.push([
            p.nome.substring(0, 40),
            p.qtd,
            fmtBR(p.faturamento),
            p.margem + '%',
            p.taxaEfetiva.toFixed(1) + '%',
            p.recomendacao.texto
          ]);
        });

        const csvContent = csv.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `dashboard-sacolas-${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
      }

      // Utilit√°rios
      function buildHeaderMap(row) {
        const map = {};
        Object.keys(row || {}).forEach(key => {
          map[normalizeHeader(key)] = key;
        });
        return map;
      }

      function findHeader(map, candidates) {
        for (let candidate of candidates) {
          if (map[normalizeHeader(candidate)]) {
            return map[normalizeHeader(candidate)];
          }
        }
        return null;
      }

      function normalizeHeader(s) {
        if (!s) return '';
        return String(s).toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9]/g, '');
      }

      function parseNumberRaw(value) {
        if (value == null || value === '') return 0;
        let s = String(value).trim();
        s = s.replace(/(R\$|\$|‚Ç¨|¬£)/g, '').trim();

        const hasDot = s.includes('.');
        const hasComma = s.includes(',');

        if (hasDot && hasComma) {
          if (s.lastIndexOf(',') > s.lastIndexOf('.')) {
            s = s.replace(/\./g, '').replace(/,/g, '.');
          } else {
            s = s.replace(/,/g, '');
          }
        } else if (hasComma) {
          s = s.replace(/,/g, '.');
        }

        s = s.replace(/[^\d.-]/g, '');
        const num = parseFloat(s);
        return isNaN(num) ? 0 : num;
      }

      function resetDashboard() {
        document.getElementById('dbFileInput').value = '';
        document.getElementById('dbKpis').classList.add('hidden');
        document.getElementById('dbCharts').classList.add('hidden');
        analisesDiv.classList.add('hidden');
        detalhesDiv.classList.add('hidden');
        if (dbPieChart) dbPieChart.destroy();
        if (dbTopBarChart) dbTopBarChart.destroy();
        if (dbMargemChart) dbMargemChart.destroy();
        dashboardData = null;
        showStatus('', ''); // Limpa status
      }
    }

    // Inicializa√ß√µes
    document.addEventListener('DOMContentLoaded', () => {
      initCalculadoraUI();
      initDashboardUI();
    });
  </script>

</body>

</html>
