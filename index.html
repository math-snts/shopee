<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Toolbox Shopee ‚Äî Etiquetas ‚Ä¢ Calculadora ‚Ä¢ Dashboard</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json,{
    'name': 'Toolbox Shopee',
    'short_name': 'ShopeeTool',
    'description': 'Ferramentas para vendedores Shopee',
    'start_url': '/',
    'display': 'standalone',
    'background_color': '#ff7a18',
    'theme_color': '#ff7a18',
    'icons': [
      {
        'src': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjRkY3QTE4Ii8+CjxwYXRoIGQ9Ik0xMjAgOTZIMzZWMzZIMTIwVjkyNkM5MiAxMjQgNjQgMTUyIDM0LjUgMTUyQzE1LjI1IDE1MiAwIDEzNi42NSAwIDEyMEgxMjBWMzk2SDBWMjYwSDEyMFY5NloiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
        'sizes': '192x192',
        'type': 'image/svg+xml'
      }
    ]
  }">

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Bibliotecas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ff7a18">
    <style>
        /* Enhanced visual polish */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: auto;
        }

        .app-header {
            backdrop-filter: blur(12px);
        }

        /* Smooth transitions with better easing */
        .page {
            display: none;
            animation: fadeIn .25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page.visible {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Touch targets improved */
        .nav-btn {
            padding: .75rem 1rem;
            border-radius: .75rem;
            transition: all .15s ease;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Loading spinner */
        .spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #f97316;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: .75rem;
            color: white;
            z-index: 50;
            transform: translateX(400px);
            transition: transform .3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #10b981;
        }

        .toast.error {
            background: #ef4444;
        }

        /* Improved drop zone */
        .drop-zone {
            transition: all .2s ease;
        }

        .drop-zone.dragover {
            border-color: #f97316;
            background: #fef3c7;
            transform: scale(1.02);
        }

        /* Dashboard small table tweaks so it matches the rest */
        #resultTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            font-size: 0.95rem;
        }

        #resultTable th,
        #resultTable td {
            border: 1px solid rgba(15, 23, 42, 0.06);
            padding: 0.6rem 0.8rem;
            text-align: left;
        }

        #resultTable thead th {
            background: linear-gradient(90deg, #ffedd5, #fff7ed);
            color: #1f2937;
            font-weight: 600;
        }

        /* KPI card style consistent with other sections */
        .card {
            background: white;
            padding: 1rem;
            border-radius: 1rem;
            border: 1px solid rgba(15, 23, 42, 0.04);
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.03);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
        }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-orange-50 text-slate-900 min-h-screen">

    <!-- HEADER / NAV -->
    <header class="app-header fixed top-0 left-0 right-0 z-40 bg-white/90 border-b border-slate-200/50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-yellow-400 flex items-center justify-center text-white font-bold shadow-lg">
                    SH</div>
                <div>
                    <div class="text-xl font-bold text-slate-800">Toolbox Shopee</div>
                    <div class="text-sm text-slate-500">Etiquetas ‚Ä¢ Calculadora ‚Ä¢ Dashboard Anal√≠tico</div>
                </div>
            </div>

            <nav class="hidden lg:flex items-center gap-3">
                <button
                    class="nav-btn text-sm font-semibold text-slate-700 bg-white/80 hover:bg-orange-50 border border-slate-200"
                    data-target="home">üè† In√≠cio</button>
                <button
                    class="nav-btn text-sm font-semibold text-slate-700 bg-white/80 hover:bg-orange-50 border border-slate-200"
                    data-target="etiquetas">üè∑Ô∏è Etiquetas</button>
                <button
                    class="nav-btn text-sm font-semibold text-slate-700 bg-white/80 hover:bg-orange-50 border border-slate-200"
                    data-target="calculadora">üßÆ Calculadora</button>
                <button
                    class="nav-btn text-sm font-semibold text-slate-700 bg-white/80 hover:bg-orange-50 border border-slate-200"
                    data-target="dashboard">üìä Dashboard</button>
            </nav>

            <!-- Mobile menu button -->
            <div class="lg:hidden">
                <button id="menuBtn"
                    class="p-2.5 rounded-lg border bg-white shadow-sm hover:shadow-md transition-shadow">
                    <svg id="menuIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-600" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile dropdown -->
        <div id="mobileMenu" class="lg:hidden hidden border-t bg-white/95 backdrop-blur-sm">
            <div class="px-4 py-4 flex flex-col gap-2">
                <button class="text-left p-3 rounded-lg hover:bg-orange-50 transition-colors" data-target="home">üè†
                    In√≠cio</button>
                <button class="text-left p-3 rounded-lg hover:bg-orange-50 transition-colors"
                    data-target="etiquetas">üè∑Ô∏è
                    Etiquetas</button>
                <button class="text-left p-3 rounded-lg hover:bg-orange-50 transition-colors"
                    data-target="calculadora">üßÆ
                    Calculadora</button>
                <button class="text-left p-3 rounded-lg hover:bg-orange-50 transition-colors" data-target="dashboard">üìä
                    Dashboard</button>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="pt-20 pb-16">
        <div class="max-w-6xl mx-auto px-4">

            <!-- HOME / DESCRI√á√ÉO -->
            <section id="home" class="page visible bg-white/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl mb-8">
                <div class="card">
                    <div class="flex-1 mb-6 lg:mb-0">
                        <h1 class="text-3xl lg:text-4xl font-extrabold text-slate-800 mb-4">üöÄ Toolbox Shopee ‚Äî Sua
                            Central de
                            Expedi√ß√£o & An√°lises</h1>
                        <p class="text-lg text-slate-600 mb-6 leading-relaxed">Otimize sua opera√ß√£o com ferramentas
                            integradas: gere
                            etiquetas profissionais, calcule margens precisas e analise vendas com insights acion√°veis.
                            PWA completa
                            para uso offline e mobile.</p>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div
                                class="p-6 border border-orange-200 rounded-2xl bg-gradient-to-r from-orange-50 to-yellow-50 shadow-md">
                                <div class="text-2xl mb-2">üè∑Ô∏è</div>
                                <h3 class="font-bold text-slate-800 mb-2">Gerador de Etiquetas</h3>
                                <p class="text-sm text-slate-600">ZPL ‚Üí PDF com Labelary. Suporte ZIP/TXT, drag & drop,
                                    retry autom√°tico
                                    e headers personalizados.</p>
                            </div>
                            <div
                                class="p-6 border border-yellow-200 rounded-2xl bg-gradient-to-r from-yellow-50 to-green-50 shadow-md">
                                <div class="text-2xl mb-2">üßÆ</div>
                                <h3 class="font-bold text-slate-800 mb-2">Calculadora Avan√ßada</h3>
                                <p class="text-sm text-slate-600">Comiss√µes, impostos, afiliados e margens. Salva
                                    hist√≥rico local e
                                    valida inputs em tempo real.</p>
                            </div>
                            <div
                                class="p-6 border border-purple-200 rounded-2xl bg-gradient-to-r from-purple-50 to-indigo-50 shadow-md">
                                <div class="text-2xl mb-2">üìä</div>
                                <h3 class="font-bold text-slate-800 mb-2">Dashboard Anal√≠tico</h3>
                                <p class="text-sm text-slate-600">KPIs, gr√°ficos de margens, top produtos e
                                    recomenda√ß√µes de
                                    precifica√ß√£o. Export CSV.</p>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-4 mb-8">
                            <button
                                class="bg-orange-500 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all font-semibold"
                                data-target="etiquetas">Abrir Etiquetas</button>
                            <button
                                class="bg-yellow-400 text-black px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all font-semibold"
                                data-target="calculadora">Abrir Calculadora</button>
                            <button
                                class="bg-purple-500 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all font-semibold"
                                data-target="dashboard">Abrir Dashboard</button>
                        </div>

                        <div class="text-sm text-slate-500 bg-slate-50 p-4 rounded-xl">
                            <p><strong>‚ú® Novidades:</strong> PWA offline, valida√ß√µes robustas, export de insights e
                                an√°lises
                                preditivas para decis√µes r√°pidas.</p>
                        </div>
                    </div>

                    <div class="hidden lg:block w-64">
                        <div class="bg-gradient-to-br from-orange-100 to-yellow-100 rounded-2xl p-6 shadow-lg">
                            <img src="https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=2b4a4e8f4e4e4e4e4e4e4e4e4e4e4e4"
                                alt="Dashboard mockup" class="rounded-xl shadow-md w-full" />
                        </div>
                    </div>
                </div>
            </section>

            <!-- ETIQUETAS / ZPL -> PDF -->
            <section id="etiquetas" class="page mb-8 bg-white/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">üè∑Ô∏è Gerador de Etiquetas Profissionais</h2>
                    <div class="text-sm text-slate-500 flex items-center gap-2">
                        <span>Selecione .txt ou .zip</span>
                        <div class="spinner hidden" id="etqSpinner"></div>
                    </div>
                </div>

                <div class="grid gap-6">
                    <div
                        class="flex flex-col md:flex-row gap-4 items-start p-4 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50">
                        <input type="file" id="etqFileInput" multiple
                            class="flex-1 p-3 border rounded-xl bg-white shadow-sm" accept=".txt,.zip">
                        <input type="text" id="etqRedeSocial" placeholder="Rede social (ex: Instagram @loja)"
                            class="p-3 border rounded-xl w-full md:w-64 bg-white shadow-sm">
                        <div class="flex gap-3">
                            <button id="etqProcessBtn"
                                class="bg-orange-500 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all font-semibold flex items-center gap-2">
                                Gerar PDF
                            </button>
                            <button id="etqClearBtn"
                                class="bg-white border px-6 py-3 rounded-xl shadow-sm hover:shadow-md transition-all">Limpar</button>
                        </div>
                    </div>

                    <div id="etqDropZone"
                        class="drop-zone p-8 border-2 border-dashed border-slate-200 rounded-2xl text-center text-slate-500 cursor-pointer hover:border-orange-300 transition-colors">
                        <div class="text-4xl mb-2">üìÅ</div>
                        <p class="text-lg font-medium mb-1">Arraste arquivos aqui</p>
                        <p class="text-sm">Ou clique para selecionar .txt ou .zip</p>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <span class="block text-sm font-medium text-slate-700 mb-1">Progresso:</span>
                            <span id="etqProgressText" class="text-sm text-slate-500">0/0</span>
                        </div>
                        <div class="h-3 bg-slate-200 rounded-full overflow-hidden">
                            <div id="etqProgress"
                                class="h-full bg-gradient-to-r from-orange-400 to-yellow-400 w-0 transition-all">
                            </div>
                        </div>
                        <div class="mt-2 text-sm text-slate-500 flex justify-between">
                            <span id="etqEta">Tempo: --</span>
                            <span id="etqSpeed">Velocidade: --/s</span>
                        </div>
                        <div class="mt-3 text-sm text-slate-600 max-h-32 overflow-auto p-2 bg-white rounded"
                            id="etqStatus"></div>
                    </div>
                </div>
            </section>

            <!-- CALCULADORA -->
            <section id="calculadora" class="page mb-8 bg-white/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">üßÆ Calculadora de Margens Shopee</h2>
                    <div class="text-sm text-slate-500">Valida√ß√µes autom√°ticas e hist√≥rico salvo</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Valor de Venda (R$)</label>
                        <input type="number" id="c_valorVenda" min="0" step="0.01" placeholder="Ex: 29.90"
                            class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Comiss√£o Shopee (%)</label>
                        <input type="number" id="c_taxaComissao" min="0" max="100" step="0.01" placeholder="Ex: 12.00"
                            class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Taxa de Servi√ßo (%)</label>
                        <input type="number" id="c_taxaServico" min="0" max="100" step="0.01" placeholder="Ex: 2.00"
                            class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Taxa por Item (R$)</label>
                        <input type="number" id="c_taxaItem" min="0" step="0.01" placeholder="Ex: 0.50"
                            class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Al√≠quota Imposto (%)</label>
                        <input type="number" id="c_aliquota" min="0" max="100" step="0.01" placeholder="Ex: 12.00"
                            class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Afiliado (%)</label>
                        <input type="number" id="c_afiliado" min="0" max="100" step="0.01" placeholder="Ex: 5.00"
                            class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Pre√ßo de Custo (R$)</label>
                        <input type="number" id="c_precoCusto" min="0" step="0.01" placeholder="Ex: 15.00"
                            class="w-full p-3 border rounded-xl shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                </div>

                <div class="flex gap-4 mb-6">
                    <button id="c_calcularBtn"
                        class="bg-orange-500 text-white px-8 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all font-semibold flex items-center gap-2">
                        Calcular Margem
                    </button>
                    <button id="c_limparBtn"
                        class="bg-white border px-8 py-3 rounded-xl shadow-sm hover:shadow-md transition-all">Limpar</button>
                    <button id="c_salvarBtn"
                        class="bg-green-500 text-white px-8 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all">üíæ
                        Salvar</button>
                </div>

                <div id="c_resultado"
                    class="hidden bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-2xl border border-green-200">
                    <h3 class="text-xl font-bold text-green-800 mb-4">Resultados da An√°lise</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <strong class="text-lg text-green-700 block mb-1">Taxa Shopee Total</strong>
                            <span class="text-2xl font-bold">R$ <span id="c_taxaShopee">0</span></span>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <strong class="text-lg text-blue-700 block mb-1">Valor L√≠quido</strong>
                            <span class="text-2xl font-bold">R$ <span id="c_valorLiquido">0</span></span>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <strong class="text-lg text-emerald-700 block mb-1">Lucro L√≠quido</strong>
                            <span class="text-2xl font-bold">R$ <span id="c_lucroLiquido">0</span></span>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <strong class="text-lg text-purple-700 block mb-1">Imposto Estimado</strong>
                            <span class="text-2xl font-bold">R$ <span id="c_imposto">0</span></span>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <strong class="text-lg text-pink-700 block mb-1">Afiliado</strong>
                            <span class="text-2xl font-bold">R$ <span id="c_afiliadoValor">0</span></span>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <strong class="text-lg text-orange-700 block mb-1">Margem Final</strong>
                            <span class="text-2xl font-bold text-orange-600"><span id="c_margem">0</span>%</span>
                        </div>
                    </div>
                </div>

                <!-- Hist√≥rico Salvo -->
                <div id="c_historico" class="hidden mt-6">
                    <h4 class="text-lg font-bold mb-3">üìã Hist√≥rico de C√°lculos</h4>
                    <div id="c_historicoList" class="space-y-2 max-h-40 overflow-auto bg-slate-50 p-4 rounded-xl"></div>
                </div>
            </section>


            <!-- DASHBOARD -->
            <section id="dashboard" class="page mb-8 bg-white/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl">
                <div class="container">
                    <h1 class="text-lg font-bold">Dashboard de Vendas Shopee</h1>
                    <!-- upload alinhado ao estilo -->
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv"
                        class="p-2 border rounded-xl bg-white shadow-sm" />
                    <button id="processBtn" onclick="processFile()"
                        class="bg-orange-500 text-white px-4 py-2 rounded-xl shadow hover:shadow-lg">Processar</button>


                    <!-- KPIs: deixei em grid para combinar com o estilo das outras se√ß√µes -->
                    <div class="cards">
                        <div class="card">
                            <h2 class="lg:flex lg:items-center lg:gap-8">Faturamento Total</h2>
                            <p id="fatTotal" class="text-xl font-bold mt-2">R$ 0,00</p>
                        </div>
                        <div class="card">
                            <h2 class="lg:flex lg:items-center lg:gap-8">Faturamento Conclu√≠das</h2>
                            <p id="fatConcluido" class="text-xl font-bold mt-2">R$ 0,00</p>
                        </div>
                        <div class="card">
                            <h2 class="lg:flex lg:items-center lg:gap-8">Faturamento Canceladas</h2>
                            <p id="fatCancelado" class="text-xl font-bold mt-2">R$ 0,00</p>
                        </div>
                        <div class="card">
                            <h2 class="lg:flex lg:items-center lg:gap-8">Qtd. Vendas Conclu√≠das</h2>
                            <p id="qtdConcluidas" class="text-xl font-bold mt-2">0</p>
                        </div>
                        <div class="card">
                            <h2 class="lg:flex lg:items-center lg:gap-8">Qtd. Vendas Canceladas</h2>
                            <p id="qtdCanceladas" class="text-xl font-bold mt-2">0</p>
                        </div>
                        <div class="card">
                            <h2 class="lg:flex lg:items-center lg:gap-8">Valor Pago √† Plataforma</h2>
                            <p id="taxas" class="text-xl font-bold mt-2">R$ 0,00</p>
                        </div>
                        <div class="card">
                            <h2 class="lg:flex lg:items-center lg:gap-8">Imposto (10%)</h2>
                            <p id="imposto" class="text-xl font-bold mt-2">R$ 0,00</p>
                        </div>
                        <div class="card">
                            <h2 class="lg:flex lg:items-center lg:gap-8">Lucro L√≠quido</h2>
                            <p id="lucroLiquido" class="text-xl font-bold mt-2">R$ 0,00</p>
                        </div>
                    </div>

                    <!-- tabela -->
                    <div class="col-span-1 md:col-span-3 mt-4">
                        <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold text-slate-800">Pedidos Processados</h3>
                                <div class="flex items-center gap-2">
                                    <button onclick="exportCSV()"
                                        class="bg-white border px-4 py-2 rounded-xl shadow-sm hover:shadow-md">Exportar
                                        CSV</button>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table id="resultTable" class="min-w-full">
                                    <thead>
                                        <tr>
                                            <th>ID Pedido</th>
                                            <th>Status</th>
                                            <th>Qtd Itens</th>
                                            <th>Valor Total</th>
                                            <th>Taxas</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </section>
    </main>

    <!-- FOOTER -->
    <footer class="fixed bottom-6 left-1/2 -translate-x-1/2 z-30">
        <div
            class="bg-white/95 backdrop-blur-sm px-6 py-3 rounded-full shadow-lg flex items-center gap-3 text-sm text-slate-600">
            <span>‚ú® Feitopara vendedores Shopee | DEOliveira Matheus</span>
        </div>
    </footer>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- SCRIPTS: SPA, PWA, integra√ß√µes -->
    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
        const CACHE_NAME = 'toolbox-v2';
        const urlsToCache = ['/', 'https://cdn.tailwindcss.com'];
        
        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME)
              .then(cache => cache.addAll(urlsToCache))
          );
        });
        
        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request)
              .then(response => response || fetch(event.request))
          );
        });
      `)).then(reg => console.log('SW registrado')).catch(err => console.log('SW erro:', err));
            });
        }

        /* ---------- Global Error Handler ---------- */
        window.addEventListener('error', (e) => {
            showToast('Ops! Erro detectado. Verifique o console (F12).', 'error');
            console.error('Erro global:', e.error);
        });

        /* ---------- Toast Notifications ---------- */
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        /* ---------- SPA Navigation ---------- */
        const pages = document.querySelectorAll('.page');
        function showPage(id) {
            pages.forEach(p => p.classList.remove('visible'));
            const el = document.getElementById(id);
            if (el) el.classList.add('visible');
            // Lazy init
            if (id === 'etiquetas') initEtiquetasUI();
            if (id === 'calculadora') initCalculadoraUI();
            if (id === 'dashboard') initDashboardUI();
            // Close mobile menu
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu) mobileMenu.classList.add('hidden');
            // Update URL for PWA
            history.pushState({ page: id }, '', `#${id}`);
        }
        document.querySelectorAll('[data-target]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const t = e.currentTarget.dataset.target;
                showPage(t);
            });
        });
        // Mobile menu
        const menuBtn = document.getElementById('menuBtn');
        if (menuBtn) {
            menuBtn.addEventListener('click', () => {
                document.getElementById('mobileMenu').classList.toggle('hidden');
            });
        }
        // Popstate for back button
        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.page) showPage(e.state.page);
        });

        /* ---------- UTIL ---------- */
        function fmtBR(value) {
            try {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            } catch (e) {
                return 'R$ ' + Number(value).toFixed(2).replace('.', ',');
            }
        }

        /* ============================
           ETIQUETAS (ZPL -> PDF) - MELHORADO
           ============================ */
        let globalData = [];

        function parseValor(v) {
            if (v === null || v === undefined || v === "") return 0;
            let str = v.toString().replace("R$", "").trim();

            if (str.includes(",") && str.includes(".")) {
                str = str.replace(/\./g, "").replace(",", ".");
            } else if (str.includes(",")) {
                str = str.replace(",", ".");
            }
            const num = parseFloat(str);
            return isNaN(num) ? 0 : num;
        }

        function processFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) { showToast("Selecione um arquivo!", "error"); return; }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    // use sheet_to_json com defval para garantir chaves
                    const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

                    if (!rows.length) {
                        showToast("Arquivo sem dados.", "error");
                        return;
                    }

                    // tenta descobrir colunas automaticamente
                    const cols = Object.keys(rows[0]).map(c => c.toLowerCase());
                    const idCol = Object.keys(rows[0]).find(c => c.toLowerCase().includes("id")) || Object.keys(rows[0])[0];
                    const statusCol = Object.keys(rows[0]).find(c => c.toLowerCase().includes("status")) || Object.keys(rows[0])[1];
                    const amountCol = Object.keys(rows[0]).find(c => c.toLowerCase().includes("valor") || c.toLowerCase().includes("total")) || Object.keys(rows[0])[2];

                    // todas as colunas de taxas/comiss√£o
                    const feeCols = Object.keys(rows[0]).filter(c =>
                        c.toLowerCase().includes("taxa") || c.toLowerCase().includes("comiss√£o") || c.toLowerCase().includes("fee")
                    );

                    let pedidos = {};

                    rows.forEach(row => {
                        const id = row[idCol];
                        if (id === undefined || id === null || id === "") return; // ignora linha sem id
                        const status = (row[statusCol] || "").toString().toLowerCase();
                        const valor = parseValor(row[amountCol]);

                        // somar todas as taxas
                        let taxasSomadas = 0;
                        feeCols.forEach(fc => {
                            taxasSomadas += parseValor(row[fc]);
                        });

                        if (!pedidos[id]) {
                            pedidos[id] = { id, statusList: [], valor: 0, taxa: 0, itens: 0 };
                        }
                        pedidos[id].valor += valor;
                        pedidos[id].taxa += taxasSomadas;
                        pedidos[id].itens++;
                        pedidos[id].statusList.push(status);
                    });

                    Object.values(pedidos).forEach(p => {
                        // se todas as entradas tiverem cancel -> cancelado, sen√£o conclu√≠do
                        if (p.statusList.length && p.statusList.every(s => s.includes("cancel") || s.includes("cancelado"))) {
                            p.status = "Cancelado";
                        } else {
                            p.status = "Conclu√≠do";
                        }
                    });

                    globalData = Object.values(pedidos);
                    atualizarDashboard();
                    showToast("Arquivo processado com sucesso!", "success");
                    // abre a aba dashboard
                    showPage('dashboard');
                } catch (err) {
                    console.error(err);
                    showToast("Erro ao processar arquivo. Veja o console.", "error");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function atualizarDashboard() {
            let fatTotal = 0, fatConcluido = 0, fatCancelado = 0, taxas = 0;
            let qtdConcluidas = 0, qtdCanceladas = 0;

            globalData.forEach(p => {
                fatTotal += (p.valor || 0);
                taxas += (p.taxa || 0);
                if ((p.status || "").toLowerCase() === "conclu√≠do" || (p.status || "").toLowerCase().includes("concl")) {
                    fatConcluido += (p.valor || 0);
                    qtdConcluidas++;
                } else if ((p.status || "").toLowerCase() === "cancelado" || (p.status || "").toLowerCase().includes("cancel")) {
                    fatCancelado += (p.valor || 0);
                    qtdCanceladas++;
                }
            });

            let imposto = fatConcluido * 0.10;
            let lucroLiquido = fatConcluido - taxas - imposto;

            document.getElementById("fatTotal").innerText = fmtBR(fatTotal);
            document.getElementById("fatConcluido").innerText = fmtBR(fatConcluido);
            document.getElementById("fatCancelado").innerText = fmtBR(fatCancelado);
            document.getElementById("qtdConcluidas").innerText = qtdConcluidas;
            document.getElementById("qtdCanceladas").innerText = qtdCanceladas;
            document.getElementById("taxas").innerText = fmtBR(taxas);
            document.getElementById("imposto").innerText = fmtBR(imposto);
            document.getElementById("lucroLiquido").innerText = fmtBR(lucroLiquido);

            const tbody = document.querySelector("#resultTable tbody");
            tbody.innerHTML = "";
            globalData.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.status}</td>
      <td>${p.itens}</td>
      <td>${fmtBR(p.valor)}</td>
      <td>${fmtBR(p.taxa)}</td>
    `;
                tbody.appendChild(tr);
            });
        }

        function exportCSV() {
            if (!globalData.length) { showToast("Nenhum dado para exportar", "error"); return; }
            const headers = ["ID Pedido", "Status", "Qtd Itens", "Valor Total", "Taxas"];
            const rows = globalData.map(p => [p.id, p.status, p.itens, p.valor, p.taxa]);

            let csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].map(r => r.map(cell => {
                // escape ponto e v√≠rgula/csv
                if (typeof cell === "string") {
                    return '"' + cell.replace(/"/g, '""') + '"';
                }
                return cell;
            }).join(";")).join("\n");

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "relatorio_shopee.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast("CSV exportado", "success");
        }

        function formatar(v) {
            return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        }

        /* ---------- Stubs / Inits para evitar erros de lazy init ---------- */
        function initCalculadoraUI() {
            // Placeholder: se voc√™ tiver l√≥gica de inicializa√ß√£o da calculadora, coloque aqui.
            // Exemplo: attach event listeners aos bot√µes da calculadora
            // S√≥ adicionamos se ainda n√£o ligado
            if (initCalculadoraUI.ran) return;
            initCalculadoraUI.ran = true;

            const btnCalcular = document.getElementById('c_calcularBtn');
            if (btnCalcular) {
                btnCalcular.addEventListener('click', () => {
                    // pequena l√≥gica de demo, sua l√≥gica principal permanece a mesma
                    const venda = parseFloat(document.getElementById('c_valorVenda').value) || 0;
                    const custo = parseFloat(document.getElementById('c_precoCusto').value) || 0;
                    const margem = venda ? Math.max(0, ((venda - custo) / venda) * 100) : 0;
                    document.getElementById('c_margem').innerText = margem.toFixed(2);
                    document.getElementById('c_resultado').classList.remove('hidden');
                });
            }
        }

        function initEtiquetasUI() {
            if (initEtiquetasUI.ran) return;
            initEtiquetasUI.ran = true;
            // se existir l√≥gica para drag/drop ou bot√µes
            const drop = document.getElementById('etqDropZone');
            const input = document.getElementById('etqFileInput');
            if (drop && input) {
                drop.addEventListener('click', () => input.click());
                ['dragenter', 'dragover'].forEach(ev => {
                    drop.addEventListener(ev, (e) => {
                        e.preventDefault();
                        drop.classList.add('dragover');
                    });
                });
                ['dragleave', 'drop'].forEach(ev => {
                    drop.addEventListener(ev, (e) => {
                        e.preventDefault();
                        drop.classList.remove('dragover');
                    });
                });
                drop.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    if (dt && dt.files && dt.files.length) {
                        input.files = dt.files;
                    }
                });
            }
        }

        function initDashboardUI() {
            if (initDashboardUI.ran) return;
            initDashboardUI.ran = true;
            // qualquer inicializa√ß√£o extra que desejar (ex: preparar charts futuramente)
        }

        /* ---------- DOM ready ---------- */
        document.addEventListener('DOMContentLoaded', () => {
            initCalculadoraUI();
            initEtiquetasUI();
            initDashboardUI();
        });
    </script>

</body>

</html>
